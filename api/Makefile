.PHONY: help dev build rebuild workspace logs dozzle stop down clean restart status tools test test-unit test-feature test-security test-architecture test-coverage test-watch fixtures migration migrate cache cleanup-tokens

# Variables
COMPOSE_FILE=compose.dev.yaml
CONTAINER_NAME=webapp
DB_CONTAINER=chatrealtime-postgres

# Default target
help:
	@echo "ğŸš€ Symfony Chat Realtime - Available commands:"
	@echo ""
	@echo "ğŸ³ Docker Commands:"
	@echo "  dev      - Start development server"
	@echo "  build    - Build containers"
	@echo "  rebuild  - Rebuild and restart all containers"
	@echo "  workspace- Open bash in webapp container"
	@echo "  logs     - Show container logs"
	@echo "  dozzle   - Open Dozzle logs viewer in browser"
	@echo "  stop     - Stop all containers"
	@echo "  down     - Stop and remove containers"
	@echo "  clean    - Clean containers, images and volumes"
	@echo "  restart  - Restart all containers"
	@echo "  status   - Show container status"
	@echo ""
	@echo "ğŸ› ï¸  Development Commands:"
	@echo "  tools    - Run PHPStan analysis"
	@echo "  cache    - Clear Symfony cache"
	@echo ""
	@echo "ğŸ§ª Testing Commands:"
	@echo "  test            - Run all tests"
	@echo "  test-unit       - Run unit tests only"
	@echo "  test-feature    - Run feature tests only"
	@echo "  test-security   - Run security tests only"
	@echo "  test-architecture - Run architecture tests only"
	@echo "  test-coverage   - Run tests with code coverage report"
	@echo "  test-watch      - Run tests in watch mode"
	@echo ""
	@echo "ğŸ—„ï¸  Database Commands:"
	@echo "  fixtures      - Load Doctrine fixtures"
	@echo "  migration     - Create new migration"
	@echo "  migrate       - Run database migrations"
	@echo ""
	@echo "ğŸ”’ Security Commands:"
	@echo "  cleanup-tokens - Delete expired refresh tokens from database"

############# Docker Commands #############
dev:
	@echo "ğŸš€ Starting Symfony Chat Realtime development environment..."
	@echo ""
	@echo "ğŸ“¦ Services starting:"
	@echo "  â€¢ Webapp (FrankenPHP) - https://localhost"
	@echo "  â€¢ PostgreSQL - localhost:5432"
	@echo "  â€¢ Adminer - http://localhost:9080"
	@echo "  â€¢ Maildev - http://localhost:1080"
	@echo "  â€¢ Dozzle (logs) - http://localhost:8888"
	@echo ""
	@echo "â³ Starting containers..."
	@docker compose -f $(COMPOSE_FILE) up -d
	@echo ""
	@echo "âœ… Development environment started successfully!"
	@echo ""
	@echo "ğŸ”— Useful links:"
	@echo "  â€¢ App: https://localhost"
	@echo "  â€¢ Database (Adminer): http://localhost:9080"
	@echo "  â€¢ Mail catcher: http://localhost:1080"
	@echo "  â€¢ Logs viewer: http://localhost:8888"
	@echo ""
	@echo "ğŸ’¡ Use 'make logs' to view logs or 'make dozzle' to open the logs viewer"
	@echo "   Use 'make help' for all available commands"

build:
	@echo "ğŸ”¨ Building containers..."
	@docker compose -f $(COMPOSE_FILE) build

rebuild:
	@echo "ğŸ”„ Rebuilding and restarting all containers..."
	@docker compose -f $(COMPOSE_FILE) down
	@docker compose -f $(COMPOSE_FILE) build --no-cache
	@docker compose -f $(COMPOSE_FILE) up -d

workspace:
	@echo "ğŸ’» Opening workspace in $(CONTAINER_NAME)..."
	@docker compose -f $(COMPOSE_FILE) exec $(CONTAINER_NAME) bash

logs:
	@echo "ğŸ“‹ Showing container logs..."
	@docker compose -f $(COMPOSE_FILE) logs -f

dozzle:
	@echo "ğŸŒ Opening Dozzle logs viewer..."
	@docker compose -f $(COMPOSE_FILE) up -d dozzle || true
	@echo "Dozzle available at: http://localhost:8888"

stop:
	@echo "â¹ï¸  Stopping all containers..."
	@docker compose -f $(COMPOSE_FILE) stop

down:
	@echo "â¬‡ï¸  Stopping and removing containers..."
	@docker compose -f $(COMPOSE_FILE) down

clean:
	@echo "ğŸ§¹ Cleaning containers, images and volumes..."
	@docker compose -f $(COMPOSE_FILE) down -v --remove-orphans

restart:
	@echo "ğŸ”„ Restarting all containers..."
	@docker compose -f $(COMPOSE_FILE) restart

status:
	@echo "ğŸ“Š Container status:"
	@docker compose -f $(COMPOSE_FILE) ps
############# Development Commands #############
tools:
	@echo "ğŸ” Running PHPStan analysis..."
	@docker compose -f $(COMPOSE_FILE) exec $(CONTAINER_NAME) vendor/bin/phpstan analyse src

cache:
	@echo "ğŸ—„ï¸  Clearing Symfony cache..."
	@docker compose -f $(COMPOSE_FILE) exec -it $(CONTAINER_NAME) php bin/console cache:clear

############# Testing Commands #############
test:
	@echo "ğŸ§ª Running all tests..."
	@docker compose -f $(COMPOSE_FILE) exec $(CONTAINER_NAME) vendor/bin/pest --no-coverage

test-unit:
	@echo "ğŸ§ª Running unit tests..."
	@docker compose -f $(COMPOSE_FILE) exec $(CONTAINER_NAME) vendor/bin/pest --testsuite=Unit --no-coverage

test-feature:
	@echo "ğŸ§ª Running feature tests..."
	@docker compose -f $(COMPOSE_FILE) exec $(CONTAINER_NAME) vendor/bin/pest --testsuite=Feature --no-coverage

test-security:
	@echo "ğŸ§ª Running security tests..."
	@docker compose -f $(COMPOSE_FILE) exec $(CONTAINER_NAME) vendor/bin/pest --testsuite=Security --no-coverage

test-architecture:
	@echo "ğŸ§ª Running architecture tests..."
	@docker compose -f $(COMPOSE_FILE) exec $(CONTAINER_NAME) vendor/bin/pest --testsuite=Architecture --no-coverage

test-coverage:
	@echo "ğŸ§ª Running tests with code coverage..."
	@docker compose -f $(COMPOSE_FILE) exec $(CONTAINER_NAME) vendor/bin/pest --coverage --min=80

test-watch:
	@echo "ğŸ§ª Running tests in watch mode..."
	@docker compose -f $(COMPOSE_FILE) exec $(CONTAINER_NAME) vendor/bin/pest --watch

####################################

############# Database Commands #############
fixtures:
	@echo "ğŸ“¦ Loading Doctrine fixtures..."
	@docker compose -f $(COMPOSE_FILE) exec -it $(CONTAINER_NAME) php bin/console doctrine:fixtures:load --no-interaction

migration:
	@echo "ğŸ“„ Creating new migration..."
	@docker compose -f $(COMPOSE_FILE) exec -it $(CONTAINER_NAME) php bin/console make:migration

migrate:
	@echo "ğŸš€ Running database migrations..."
	@docker compose -f $(COMPOSE_FILE) exec -it $(CONTAINER_NAME) php bin/console doctrine:migrations:migrate --no-interaction

############# Security Commands #############
cleanup-tokens:
	@echo "ğŸ”’ Cleaning up expired refresh tokens..."
	@docker compose -f $(COMPOSE_FILE) exec -it $(CONTAINER_NAME) php bin/console app:cleanup-expired-tokens